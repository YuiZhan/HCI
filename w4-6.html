<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meme-Bot 表情實驗室</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #EBE9E4;
            color: #2D2D2D;
        }

        /* 呼吸懸浮動畫 */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float {
            animation: float 4s ease-in-out infinite;
        }

        /* 眨眼動畫 */
        @keyframes blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }
        .animate-blink {
            animation: blink 4s infinite;
        }

        /* 背景網格 */
        .bg-grid {
            background-image: radial-gradient(#444 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* CRT 掃描線 */
        .scanlines {
            background: linear-gradient(
                rgba(18, 16, 16, 0) 50%,
                rgba(0, 0, 0, 0.25) 50%
            ),
            linear-gradient(
                90deg,
                rgba(255, 0, 0, 0.06),
                rgba(0, 255, 0, 0.02),
                rgba(0, 0, 255, 0.06)
            );
            background-size: 100% 2px, 3px 100%;
        }

        /* 打印動畫 */
        @keyframes print-slide {
            0% { transform: translateY(-100%) scale(0.9); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        .animate-print {
            animation: print-slide 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 selection:bg-amber-200 overflow-y-auto">

    <!-- 背景裝飾 -->
    <div class="fixed inset-0 pointer-events-none opacity-5 bg-grid"></div>

    <div class="max-w-md w-full relative z-10 py-8">
        
        <!-- 標題區 -->
        <div class="mb-8 text-center">
            <div class="inline-flex items-center gap-2 border-2 border-black px-4 py-1 rounded-full bg-white shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                <i data-lucide="terminal" class="w-4 h-4"></i>
                <h1 class="text-lg font-bold tracking-tighter">MEME-BOT 表情實驗室 v2.2</h1>
            </div>
        </div>

        <!-- 機器人展示區 -->
        <div class="bg-white/50 backdrop-blur-sm border-2 border-black rounded-3xl p-8 pb-12 mb-6 shadow-[8px_8px_0px_0px_rgba(0,0,0,0.1)] relative z-20">
            
            <!-- 對話氣泡 -->
            <div class="absolute top-4 left-0 right-0 px-4 flex justify-center z-20">
                <div id="speech-bubble" class="bg-white border-2 border-black rounded-2xl px-6 py-4 max-w-[280px] text-center shadow-lg transition-all duration-300 transform origin-bottom">
                    <p id="speech-text" class="text-sm md:text-base font-bold leading-relaxed text-black">
                        "準備好生成迷因了嗎？"
                    </p>
                    <!-- 氣泡尾巴 -->
                    <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white border-b-2 border-r-2 border-black rotate-45"></div>
                </div>
            </div>

            <div class="mt-16 flex justify-center relative">
                <!-- 機器人本體 -->
                <div id="robot-container" class="animate-float relative flex flex-col items-center justify-center transition-transform duration-300 z-10">
                    
                    <!-- 天線 -->
                    <div class="w-1 h-8 bg-stone-400 mb-[-5px] relative z-0">
                        <div id="antenna-light" class="absolute -top-2 -left-1.5 w-4 h-4 rounded-full bg-green-400 shadow-[0_0_10px_rgba(74,222,128,0.5)] transition-colors duration-300"></div>
                    </div>

                    <!-- 頭部 -->
                    <div class="relative z-10 w-48 h-40 bg-[#8B5E3C] rounded-2xl border-b-8 border-r-8 border-[#5D3A22] shadow-2xl flex items-center justify-center overflow-hidden">
                        <div class="absolute top-2 left-4 w-40 h-1 bg-[#A06F48] opacity-30 rounded-full"></div>
                        <div class="absolute bottom-4 right-4 w-20 h-1 bg-[#A06F48] opacity-30 rounded-full"></div>

                        <!-- 臉部螢幕 -->
                        <div id="face-screen" class="w-36 h-24 bg-black rounded-lg relative flex items-center justify-center gap-6 overflow-hidden border-2 border-[#333] shadow-[inset_0_0_20px_rgba(0,0,0,1)]">
                            <div class="scanlines absolute inset-0 z-20 pointer-events-none"></div>

                            <div id="eyes-container" class="flex gap-6 z-10">
                                <div class="eye-neutral w-4 h-4 bg-green-400 rounded-full animate-blink shadow-[0_0_10px_#4ade80]"></div>
                                <div class="eye-neutral w-4 h-4 bg-green-400 rounded-full animate-blink shadow-[0_0_10px_#4ade80]"></div>
                            </div>
                            
                            <div id="loading-text" class="hidden absolute inset-0 bg-white/10 flex items-center justify-center z-30">
                                <span class="font-mono text-xs text-green-500 animate-pulse">GENERATING...</span>
                            </div>
                        </div>
                    </div>

                    <!-- 身體 -->
                    <div class="w-32 h-24 bg-[#8B5E3C] -mt-2 rounded-b-3xl border-b-8 border-r-8 border-[#5D3A22] shadow-xl relative flex flex-col items-center pt-4 z-20">
                        <!-- 胸口面板 -->
                        <div class="w-20 h-12 bg-[#4A3728] rounded border border-[#6B4E3A] flex items-center justify-center gap-2 mb-2">
                            <div id="led-joy" class="w-2 h-2 rounded-full bg-gray-600 transition-colors"></div>
                            <div id="led-anger" class="w-2 h-2 rounded-full bg-gray-600 transition-colors"></div>
                            <div id="led-sadness" class="w-2 h-2 rounded-full bg-gray-600 transition-colors"></div>
                        </div>
                        <!-- 出紙口 -->
                        <div class="w-24 h-2 bg-black rounded-full mt-2 border-b border-gray-700"></div>
                    </div>
                </div>

                <!-- 迷因卡片 (從機器人身後滑出) -->
                <div id="meme-output-slot" class="absolute top-[280px] left-0 right-0 flex justify-center pointer-events-none z-0">
                    <div id="meme-card" class="hidden bg-white p-3 border-2 border-black rounded-lg shadow-xl rotate-[-2deg] max-w-[250px] transition-all">
                        <img id="meme-image" src="" alt="Meme" class="w-full h-auto rounded border border-gray-200 block bg-gray-100 min-h-[150px]" loading="lazy">
                        <div class="mt-2 flex justify-between items-center border-t border-gray-200 pt-2">
                            <span class="text-[10px] text-gray-400 font-mono">MemeBot_v2.2</span>
                            <div class="flex gap-1">
                                <div class="w-2 h-2 rounded-full bg-red-400"></div>
                                <div class="w-2 h-2 rounded-full bg-yellow-400"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- 佔位符，確保迷因卡片滑出時不會被切掉 -->
            <div id="spacer" class="h-4 transition-all duration-500"></div>
        </div>

        <!-- 控制面板 -->
        <div class="grid grid-cols-3 gap-4 relative z-30 bg-[#EBE9E4] pt-4">
            <button onclick="changeMood('joy')" class="group relative bg-[#FFD93D] border-2 border-black rounded-xl p-4 flex flex-col items-center gap-2 hover:-translate-y-1 hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:translate-y-0 active:shadow-none transition-all cursor-pointer">
                <i data-lucide="sparkles" class="w-6 h-6 text-black group-hover:scale-110 transition-transform"></i>
                <span class="text-xs font-bold tracking-widest">JOY</span>
            </button>

            <button onclick="changeMood('anger')" class="group relative bg-[#FF6B6B] border-2 border-black rounded-xl p-4 flex flex-col items-center gap-2 hover:-translate-y-1 hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:translate-y-0 active:shadow-none transition-all cursor-pointer">
                <i data-lucide="zap" class="w-6 h-6 text-black group-hover:scale-110 transition-transform"></i>
                <span class="text-xs font-bold tracking-widest">ANGER</span>
            </button>

            <button onclick="changeMood('sadness')" class="group relative bg-[#4D96FF] border-2 border-black rounded-xl p-4 flex flex-col items-center gap-2 hover:-translate-y-1 hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:translate-y-0 active:shadow-none transition-all cursor-pointer">
                <i data-lucide="cloud-rain" class="w-6 h-6 text-black group-hover:scale-110 transition-transform"></i>
                <span class="text-xs font-bold tracking-widest">SAD</span>
            </button>
        </div>

        <!-- 重置按鈕 -->
        <div class="mt-6 flex justify-center pb-8">
            <button onclick="changeMood('neutral')" class="flex items-center gap-2 text-gray-500 hover:text-black transition-colors text-xs font-mono uppercase tracking-widest cursor-pointer">
                <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                Reset
            </button>
        </div>

    </div>

    <script>
        lucide.createIcons();

        let isGlitching = false;

        // 核心修正：Memegen 特殊字符轉義函數
        // 解決 URL 編碼不正確導致圖片 404 的問題
        function formatMemeText(text) {
            if (!text) return '_'; // 空文字轉為 _
            return text.trim()
                .replace(/_/g, '__')   // 底線轉雙底線
                .replace(/-/g, '--')   // 連接號轉雙連接號
                .replace(/ /g, '_')    // 空格轉底線
                .replace(/\?/g, '~q')  // 問號
                .replace(/%/g, '~p')   // 百分比
                .replace(/#/g, '~h')   // 井號
                .replace(/\//g, '~s')  // 斜線
                .replace(/"/g, "''");  // 雙引號
        }

        // 迷因資料庫：全面更新為官方標準 ID
        const memeDatabase = {
            joy: [
                { 
                    speech: "好耶！這才是人生嘛！", 
                    template: "success", 
                    top: "CODE WORKS", 
                    bottom: "FIRST TRY" 
                },
                { 
                    speech: "今天的心情比剛出爐的薯條還脆。", 
                    template: "doge", 
                    top: "WOW", 
                    bottom: "SUCH HAPPY" 
                },
                { 
                    speech: "我看你是懂幽默的喔！", 
                    template: "buzz", // 修正 ID: toystory -> buzz
                    top: "MEMES", 
                    bottom: "MEMES EVERYWHERE" 
                },
                { 
                    speech: "這就對了！繼續保持！", 
                    template: "drake", 
                    top: "FIXING BUGS", 
                    bottom: "IGNORING BUGS" 
                }
            ],
            anger: [
                { 
                    speech: "哼，試試？警告：耐心值低於 5%。", 
                    template: "grumpy-cat", // 修正 ID: grumpycat -> grumpy-cat
                    top: "I HAD FUN ONCE", 
                    bottom: "IT WAS AWFUL" 
                },
                { 
                    speech: "我看你是欠電了是吧？", 
                    template: "batman", 
                    top: "STOP", 
                    bottom: "JUST STOP" 
                },
                { 
                    speech: "CPU 溫度飆升中，別惹我。", 
                    template: "michael-scott", // 修正 ID: no -> michael-scott
                    top: "NO GOD", 
                    bottom: "PLEASE NO" 
                },
                { 
                    speech: "這就是你對待人工智慧的態度嗎？", 
                    template: "taken", 
                    top: "I WILL FIND YOU", 
                    bottom: "AND I WILL END YOU" 
                }
            ],
            sadness: [
                { 
                    speech: "嗚嗚... 我只是一塊沒有靈魂的木頭...", 
                    template: "pablo", // 修正 ID: sad-pablo -> pablo
                    top: "", 
                    bottom: "WAITING FOR DEPLOYMENT" 
                },
                { 
                    speech: "感覺像是被無限迴圈困住了。", 
                    template: "firstworld", 
                    top: "MY CODE IS BROKEN", 
                    bottom: "AND I DON'T KNOW WHY" 
                },
                { 
                    speech: "別管我，我去角落長香菇了。", 
                    template: "fine", 
                    top: "THIS IS FINE", 
                    bottom: "EVERYTHING IS FINE" 
                }
            ],
            neutral: [
                { 
                    speech: "系統待機中... 啵。", 
                    template: "fry", 
                    top: "NOT SURE IF BUG", 
                    bottom: "OR FEATURE" 
                },
                { 
                    speech: "正在分析你的微表情...", 
                    template: "ancient-aliens", // 修正 ID: aliens -> ancient-aliens
                    top: "HUMANS", 
                    bottom: "" 
                }
            ]
        };

        const eyesContainer = document.getElementById('eyes-container');
        const speechText = document.getElementById('speech-text');
        const speechBubble = document.getElementById('speech-bubble');
        const loadingText = document.getElementById('loading-text');
        const faceScreen = document.getElementById('face-screen');
        const antennaLight = document.getElementById('antenna-light');
        const ledJoy = document.getElementById('led-joy');
        const ledAnger = document.getElementById('led-anger');
        const ledSadness = document.getElementById('led-sadness');
        
        const memeCard = document.getElementById('meme-card');
        const memeImage = document.getElementById('meme-image');
        const spacer = document.getElementById('spacer');

        const eyeTemplates = {
            joy: `
                <div class="w-8 h-4 border-t-4 border-cyan-400 rounded-t-full shadow-[0_0_10px_#22d3ee]"></div>
                <div class="w-8 h-4 border-t-4 border-cyan-400 rounded-t-full shadow-[0_0_10px_#22d3ee]"></div>
            `,
            anger: `
                <div class="w-8 h-2 bg-red-500 rotate-12 shadow-[0_0_10px_#ef4444]"></div>
                <div class="w-8 h-2 bg-red-500 -rotate-12 shadow-[0_0_10px_#ef4444]"></div>
            `,
            sadness: `
                <div class="w-8 h-2 bg-blue-500 -rotate-12 mt-2 shadow-[0_0_10px_#3b82f6]"></div>
                <div class="w-8 h-2 bg-blue-500 rotate-12 mt-2 shadow-[0_0_10px_#3b82f6]"></div>
            `,
            neutral: `
                <div class="w-4 h-4 bg-green-400 rounded-full animate-blink shadow-[0_0_10px_#4ade80]"></div>
                <div class="w-4 h-4 bg-green-400 rounded-full animate-blink shadow-[0_0_10px_#4ade80]"></div>
            `
        };

        function changeMood(mood) {
            if (isGlitching) return;

            isGlitching = true;
            
            // 1. UI 進入 Loading 狀態
            loadingText.classList.remove('hidden');
            faceScreen.classList.add('animate-pulse');
            speechBubble.classList.add('scale-95', 'opacity-80');
            eyesContainer.innerHTML = '';
            
            // 隱藏舊的迷因卡片 (如果有)
            memeCard.classList.remove('animate-print');
            memeCard.classList.add('hidden');
            spacer.style.height = '1rem'; // 重置高度

            setTimeout(() => {
                // 2. 隨機選取該情緒的迷因資料
                const dataList = memeDatabase[mood];
                const data = dataList[Math.floor(Math.random() * dataList.length)];
                
                // 3. 更新機器人對話
                speechText.innerText = `"${data.speech}"`;
                if (mood === 'anger') speechText.className = "text-sm md:text-base font-bold leading-relaxed text-red-600";
                else if (mood === 'sadness') speechText.className = "text-sm md:text-base font-bold leading-relaxed text-blue-600";
                else speechText.className = "text-sm md:text-base font-bold leading-relaxed text-black";

                // 4. 更新眼睛與燈號
                eyesContainer.innerHTML = eyeTemplates[mood];
                updateLights(mood);

                // 5. 生成迷因圖片 URL (使用新的 formatMemeText)
                const formattedTop = formatMemeText(data.top);
                const formattedBottom = formatMemeText(data.bottom);
                // 添加時間戳防止快取
                const apiUrl = `https://api.memegen.link/images/${data.template}/${formattedTop}/${formattedBottom}.png?t=${new Date().getTime()}`;
                
                memeImage.onload = null;
                memeImage.onerror = null;

                memeImage.src = apiUrl;

                const showCard = () => {
                    spacer.style.height = '280px';
                    memeCard.classList.remove('hidden');
                    memeCard.classList.add('animate-print');
                };

                // 6. UI 恢復
                loadingText.classList.add('hidden');
                faceScreen.classList.remove('animate-pulse');
                speechBubble.classList.remove('scale-95', 'opacity-80');
                speechBubble.classList.add('scale-100', 'opacity-100');

                // 7. 載入處理
                memeImage.onload = showCard;
                
                memeImage.onerror = () => {
                    console.log("Meme load failed:", apiUrl);
                    // Fallback to "This is fine"
                    memeImage.src = 'https://api.memegen.link/images/fine/404_ERROR/IMAGE_NOT_FOUND.png';
                    memeImage.onerror = null; 
                    showCard();
                };

                // 強制顯示保險機制
                setTimeout(() => {
                    if(memeCard.classList.contains('hidden')) {
                        showCard();
                    }
                }, 2000);

                isGlitching = false;
            }, 600);
        }

        function updateLights(mood) {
            ledJoy.className = "w-2 h-2 rounded-full bg-gray-600 transition-colors";
            ledAnger.className = "w-2 h-2 rounded-full bg-gray-600 transition-colors";
            ledSadness.className = "w-2 h-2 rounded-full bg-gray-600 transition-colors";
            antennaLight.className = "absolute -top-2 -left-1.5 w-4 h-4 rounded-full bg-green-400 shadow-[0_0_10px_rgba(74,222,128,0.5)] transition-colors duration-300";

            if (mood === 'joy') {
                ledJoy.className = "w-2 h-2 rounded-full bg-yellow-400 animate-bounce shadow-[0_0_5px_#facc15]";
            } else if (mood === 'anger') {
                ledAnger.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse shadow-[0_0_5px_#ef4444]";
                antennaLight.className = "absolute -top-2 -left-1.5 w-4 h-4 rounded-full bg-red-500 animate-pulse shadow-[0_0_10px_rgba(239,68,68,0.5)]";
            } else if (mood === 'sadness') {
                ledSadness.className = "w-2 h-2 rounded-full bg-blue-500 animate-bounce shadow-[0_0_5px_#3b82f6]";
            }
        }
    </script>
</body>
</html>
