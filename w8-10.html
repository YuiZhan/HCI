import React, { useState, useEffect, useRef } from 'react';
import { Music, Volume2, VolumeX, Send, Compass, X, Sparkles, MapPin, Share2 } from 'lucide-react';

// --- 資料庫：來自世界各地的回憶 ---
const MEMORY_DATABASE = [
  {
    id: 1,
    city: "巴黎",
    country: "法國",
    title: "塞納河畔的日出",
    desc: "清晨五點的薄霧中，看見艾菲爾鐵塔被染成金黃色。空氣中有剛出爐的可頌香氣。",
    tags: ["浪漫", "清晨"],
    color: "from-orange-100 to-rose-200",
    imgKeyword: "paris,sunrise"
  },
  {
    id: 2,
    city: "京都",
    country: "日本",
    title: "鴨川納涼床",
    desc: "夏日夜晚，坐在河床上聽著流水聲，手中的仙女棒剛好燃燒殆盡，留下一縷煙。",
    tags: ["寧靜", "夏夜"],
    color: "from-blue-100 to-indigo-200",
    imgKeyword: "kyoto,river"
  },
  {
    id: 3,
    city: "雷克雅維克",
    country: "冰島",
    title: "極光下的熱可可",
    desc: "零下十度，綠色的光帶在頭頂舞動。手裡的熱可可是這世界上最溫暖的東西。",
    tags: ["奇蹟", "寒冬"],
    color: "from-emerald-100 to-teal-200",
    imgKeyword: "aurora,night"
  },
  {
    id: 4,
    city: "清邁",
    country: "泰國",
    title: "萬人天燈節",
    desc: "成千上萬的燈火緩緩升空，像倒流的星星。那一刻，所有的願望似乎都被聽見了。",
    tags: ["感動", "祈福"],
    color: "from-yellow-100 to-orange-200",
    imgKeyword: "lantern,festival"
  },
  {
    id: 5,
    city: "阿爾卑斯山",
    country: "瑞士",
    title: "沒有訊號的午後",
    desc: "火車經過蜿蜒的山谷，窗外是像電腦桌布一樣不真實的草地與牛鈴聲。",
    tags: ["放鬆", "自然"],
    color: "from-green-100 to-emerald-200",
    imgKeyword: "switzerland,mountain"
  },
  {
    id: 6,
    city: "九份",
    country: "台灣",
    title: "雨中的紅燈籠",
    desc: "拾級而上，霧氣與茶香交織。遠方的海港燈火闌珊，彷彿走進了千尋的世界。",
    tags: ["懷舊", "雨天"],
    color: "from-red-100 to-orange-100",
    imgKeyword: "jiufen,lantern"
  }
];

// --- Web Audio API 合成器 (無需外部檔案) ---
// 產生療癒的氛圍音樂與音效
class AudioEngine {
  constructor() {
    this.ctx = null;
    this.oscillators = [];
    this.isPlaying = false;
  }

  init() {
    if (!this.ctx) {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  // 播放柔和的背景和弦 (Ambient Pad)
  playAmbient() {
    if (!this.ctx) this.init();
    if (this.ctx.state === 'suspended') this.ctx.resume();
    if (this.isPlaying) return;

    this.isPlaying = true;
    
    // 簡單的五聲音階和弦
    const freqs = [196.00, 261.63, 329.63, 392.00]; // G3, C4, E4, G4
    
    freqs.forEach((freq, i) => {
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      
      osc.type = 'sine';
      osc.frequency.value = freq;
      
      // 緩慢的音量起伏 (LFO 模擬)
      gain.gain.setValueAtTime(0, this.ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.03, this.ctx.currentTime + 2 + i);
      
      osc.connect(gain);
      gain.connect(this.ctx.destination);
      osc.start();
      
      this.oscillators.push({ osc, gain });
    });
  }

  stopAmbient() {
    if (!this.ctx) return;
    this.oscillators.forEach(({ osc, gain }) => {
      // 淡出
      gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 1);
      setTimeout(() => osc.stop(), 1000);
    });
    this.oscillators = [];
    this.isPlaying = false;
  }

  // 播放卡片掉落/機械音效
  playDispenseSound() {
    if (!this.ctx) this.init();
    if (this.ctx.state === 'suspended') this.ctx.resume();

    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(150, this.ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(40, this.ctx.currentTime + 0.5);
    
    gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
    
    osc.connect(gain);
    gain.connect(this.ctx.destination);
    osc.start();
    osc.stop(this.ctx.currentTime + 0.6);
  }
  
  // 播放成功獲得音效
  playSuccessSound() {
    if (!this.ctx) this.init();
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = 'sine';
    
    // 叮～的聲音
    osc.frequency.setValueAtTime(523.25, this.ctx.currentTime);
    osc.frequency.setValueAtTime(1046.50, this.ctx.currentTime + 0.1);
    
    gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 1);
    
    osc.connect(gain);
    gain.connect(this.ctx.destination);
    osc.start();
    osc.stop(this.ctx.currentTime + 1.2);
  }
}

const audioEngine = new AudioEngine();

export default function MemoVend() {
  const [isAudioOn, setIsAudioOn] = useState(false);
  const [dispensing, setDispensing] = useState(false);
  const [currentCard, setCurrentCard] = useState(null);
  const [showShareModal, setShowShareModal] = useState(false);
  const [userMemory, setUserMemory] = useState("");
  const [notification, setNotification] = useState(null);

  // 初始化 AudioContext
  const toggleAudio = () => {
    if (!isAudioOn) {
      audioEngine.playAmbient();
      setIsAudioOn(true);
    } else {
      audioEngine.stopAmbient();
      setIsAudioOn(false);
    }
  };

  const handleExplore = () => {
    if (dispensing) return;
    
    setDispensing(true);
    setCurrentCard(null);
    audioEngine.playDispenseSound();

    // 模擬機械運作時間
    setTimeout(() => {
      const randomMemory = MEMORY_DATABASE[Math.floor(Math.random() * MEMORY_DATABASE.length)];
      setCurrentCard(randomMemory);
      setDispensing(false);
      audioEngine.playSuccessSound();
    }, 1500);
  };

  const handleShareSubmit = (e) => {
    e.preventDefault();
    setShowShareModal(false);
    setUserMemory("");
    
    // 顯示感謝訊息
    setNotification("感謝你的分享！這段回憶已被販賣機收藏。");
    audioEngine.playSuccessSound();
    setTimeout(() => setNotification(null), 3000);
  };

  return (
    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans text-slate-800 relative overflow-hidden">
      
      {/* 背景裝飾 */}
      <div className="absolute inset-0 z-0 opacity-30 pointer-events-none">
        <div className="absolute top-10 left-10 w-64 h-64 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl animate-blob"></div>
        <div className="absolute top-10 right-10 w-64 h-64 bg-yellow-500 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-2000"></div>
        <div className="absolute -bottom-8 left-20 w-64 h-64 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-4000"></div>
      </div>

      {/* 主機台 */}
      <div className="relative z-10 w-full max-w-md bg-rose-50 rounded-[40px] shadow-2xl overflow-hidden border-4 border-rose-100 ring-4 ring-slate-900/10">
        
        {/* 頂部：標題與音效控制 */}
        <div className="bg-rose-200 p-4 flex justify-between items-center border-b-4 border-rose-300">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-red-400 animate-pulse"></div>
            <h1 className="font-bold text-xl text-rose-800 tracking-wider">MemoVend</h1>
          </div>
          <button 
            onClick={toggleAudio}
            className="p-2 bg-white/50 rounded-full hover:bg-white transition-colors text-rose-700"
          >
            {isAudioOn ? <Volume2 size={18} /> : <VolumeX size={18} />}
          </button>
        </div>

        {/* 玻璃展示窗 */}
        <div className="p-6 bg-gradient-to-b from-slate-800 to-slate-900 m-4 rounded-3xl relative h-64 shadow-inner overflow-hidden group">
          
          {/* 玻璃反光效果 */}
          <div className="absolute top-0 right-0 w-full h-full bg-gradient-to-tr from-white/5 to-transparent pointer-events-none z-20"></div>
          <div className="absolute top-4 right-4 w-20 h-4 bg-white/10 rounded-full blur-sm transform -rotate-12 z-20"></div>

          {/* 內部展示內容 */}
          <div className="absolute inset-0 flex flex-col items-center justify-center text-center p-4 z-10">
            {dispensing ? (
              <div className="flex flex-col items-center animate-bounce">
                <Compass size={48} className="text-rose-300 mb-2 animate-spin-slow" />
                <p className="text-rose-200 text-sm tracking-widest">搜尋記憶頻率中...</p>
              </div>
            ) : (
              <div className="space-y-3 opacity-80 group-hover:opacity-100 transition-opacity">
                <Sparkles size={32} className="text-yellow-200 mx-auto" />
                <p className="text-slate-300 text-sm font-light leading-relaxed">
                  這裡儲存著來自世界各地的片刻。<br/>
                  每一次點擊，都是一次偶遇。
                </p>
              </div>
            )}
          </div>
          
          {/* 背景星塵動效 */}
          <div className="absolute inset-0 z-0">
             {[...Array(10)].map((_, i) => (
               <div key={i} className="absolute bg-white rounded-full opacity-20 animate-pulse"
                 style={{
                   top: `${Math.random() * 100}%`,
                   left: `${Math.random() * 100}%`,
                   width: `${Math.random() * 3 + 1}px`,
                   height: `${Math.random() * 3 + 1}px`,
                   animationDuration: `${Math.random() * 3 + 2}s`
                 }}
               />
             ))}
          </div>
        </div>

        {/* 控制面板 */}
        <div className="px-8 pb-6 grid grid-cols-2 gap-4">
          
          {/* 探索按鈕 */}
          <button 
            onClick={handleExplore}
            disabled={dispensing}
            className="group relative flex flex-col items-center justify-center h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-[0_6px_0_rgb(55,48,163)] active:shadow-none active:translate-y-[6px] transition-all disabled:opacity-80 disabled:cursor-not-allowed overflow-hidden"
          >
            <div className="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <Compass className="w-8 h-8 text-white mb-1 group-hover:rotate-45 transition-transform duration-500" />
            <span className="text-white font-bold tracking-widest">探索</span>
            <span className="text-[10px] text-indigo-200 uppercase mt-1">Dispense</span>
          </button>

          {/* 分享按鈕 */}
          <button 
            onClick={() => setShowShareModal(true)}
            className="group relative flex flex-col items-center justify-center h-24 bg-gradient-to-br from-pink-400 to-rose-500 rounded-2xl shadow-[0_6px_0_rgb(190,24,93)] active:shadow-none active:translate-y-[6px] transition-all"
          >
            <div className="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <Share2 className="w-8 h-8 text-white mb-1 group-hover:-translate-y-1 transition-transform" />
            <span className="text-white font-bold tracking-widest">分享</span>
            <span className="text-[10px] text-rose-100 uppercase mt-1">Insert</span>
          </button>
        </div>

        {/* 取物口 (Collection Slot) */}
        <div className="relative mx-6 mb-8 h-40 bg-slate-800 rounded-b-lg rounded-t-3xl shadow-inner border-t-8 border-slate-700 flex items-end justify-center perspective-1000 overflow-visible">
          
          {/* 擋板陰影 */}
          <div className="absolute top-0 left-0 right-0 h-4 bg-gradient-to-b from-black/50 to-transparent z-10 pointer-events-none"></div>

          {/* 掉落的記憶卡片 */}
          {currentCard && (
            <div className="relative z-20 w-64 mb-4 animate-drop transform hover:scale-105 transition-transform duration-300 cursor-pointer group">
              <div className={`bg-white p-3 pb-5 rounded shadow-lg transform rotate-[-2deg] group-hover:rotate-0 transition-transform duration-300`}>
                
                {/* 拍立得圖片區域 */}
                <div className={`w-full h-32 bg-gradient-to-br ${currentCard.color} mb-3 rounded-sm overflow-hidden relative`}>
                    <img 
                        src={`https://source.unsplash.com/400x300/?${currentCard.imgKeyword}`} 
                        alt={currentCard.title}
                        className="w-full h-full object-cover mix-blend-multiply opacity-90 hover:opacity-100 transition-opacity"
                        onError={(e) => e.target.style.display = 'none'} 
                    />
                    <div className="absolute bottom-2 right-2 bg-white/80 backdrop-blur-sm px-2 py-0.5 rounded text-[10px] flex items-center gap-1 font-bold text-slate-600">
                        <MapPin size={10} /> {currentCard.city}
                    </div>
                </div>

                {/* 文字內容 */}
                <div className="px-1">
                  <h3 className="font-bold text-slate-800 text-sm mb-1">{currentCard.title}</h3>
                  <p className="text-[10px] text-slate-500 leading-tight mb-2 text-justify">
                    {currentCard.desc}
                  </p>
                  <div className="flex gap-1 flex-wrap">
                    {currentCard.tags.map(tag => (
                      <span key={tag} className="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded-full">#{tag}</span>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {!currentCard && !dispensing && (
            <div className="mb-12 text-slate-600 text-xs font-mono animate-pulse">
              [ WAITING FOR MEMORY ]
            </div>
          )}
        </div>

        {/* 底部裝飾條 */}
        <div className="h-4 bg-rose-300 w-full flex items-center justify-center gap-4">
             <div className="w-16 h-1 bg-rose-400/50 rounded-full"></div>
        </div>
      </div>

      {/* 分享 Modal */}
      {showShareModal && (
        <div className="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in">
          <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform scale-100 animate-scale-up">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-lg text-slate-700 flex items-center gap-2">
                <Send size={20} className="text-pink-500" />
                投入回憶
              </h3>
              <button onClick={() => setShowShareModal(false)} className="text-slate-400 hover:text-slate-600">
                <X size={20} />
              </button>
            </div>
            <form onSubmit={handleShareSubmit}>
              <p className="text-sm text-slate-500 mb-3">分享一個溫暖的瞬間，讓它成為別人的驚喜。</p>
              <textarea 
                className="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm resize-none mb-4 text-slate-700"
                placeholder="例如：在北海道販賣機買到的熱玉米湯..."
                value={userMemory}
                onChange={(e) => setUserMemory(e.target.value)}
                required
              />
              <button 
                type="submit"
                className="w-full py-3 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-xl font-bold shadow-lg shadow-pink-200 hover:shadow-xl hover:translate-y-[-2px] transition-all"
              >
                發送回憶
              </button>
            </form>
          </div>
        </div>
      )}

      {/* 通知提示 */}
      {notification && (
        <div className="absolute top-6 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur border border-green-100 text-green-700 px-4 py-2 rounded-full shadow-lg text-sm flex items-center gap-2 animate-bounce-in z-50">
          <Sparkles size={14} />
          {notification}
        </div>
      )}

      <style>{`
        @keyframes drop {
          0% { transform: translateY(-150%) rotate(5deg) scale(0.9); opacity: 0; }
          60% { transform: translateY(10%) rotate(-5deg) scale(1.02); opacity: 1; }
          80% { transform: translateY(-5%) rotate(2deg) scale(1); }
          100% { transform: translateY(0) rotate(-2deg); }
        }
        .animate-drop {
          animation: drop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        .animate-blob {
          animation: blob 7s infinite;
        }
        .animate-fade-in {
          animation: fadeIn 0.3s ease-out;
        }
        .animate-scale-up {
          animation: scaleUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .animate-bounce-in {
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .perspective-1000 {
            perspective: 1000px;
        }
        @keyframes blob {
          0% { transform: translate(0px, 0px) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
          100% { transform: translate(0px, 0px) scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleUp {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes bounceIn {
            0% { transform: translate(-50%, -200%); opacity: 0; }
            100% { transform: translate(-50%, 0); opacity: 1; }
        }
      `}</style>
    </div>
  );
}